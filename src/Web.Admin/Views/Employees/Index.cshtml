@model List<Web.Admin.ViewModels.EmployeeVm>

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>GestiÃ³n de Empleados</h2>
        
        <div>
            <a href="/Employees/Create" class="btn btn-primary">âž• Crear Empleado</a>
            <button class="btn btn-success" onclick="openImportModal()">ðŸ“„ Importar Excel</button>
        </div>
    </div>

    
    <table class="table table-striped table-hover">
        <thead class="table-dark">
        <tr>
            <th>Documento</th>
            <th>Nombre</th>
            <th>Email</th>
            <th>TelÃ©fono</th>
            <th>Departamento</th>
            <th>Fecha de Ingreso</th>
            <th>Estado</th>
            <th>Salario</th>
            <th>Acciones</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var e in Model)
        {
            <tr>
                <td>@e.Document</td>
                <td>@e.FullName</td>
                <td>@e.Email</td>
                <td>@e.Phone</td>
                <td>@e.Department</td>
                <td>@e.EntryDate.ToString("dd/MM/yyyy")</td>
                <td>@e.State</td>
                <td>@e.Salary.ToString("C")</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="openEditModal('@e.Document')">Editar</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteEmployee('@e.Document')">Eliminar</button>
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>

<!-- MODAL EDITAR -->
<div class="modal fade" id="employeeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">Editar Empleado</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <input type="hidden" id="document">

                <label>Email</label>
                <input class="form-control mb-2" id="email">

                <label>TelÃ©fono</label>
                <input class="form-control mb-2" id="phone">

                <label>Departamento</label>
                <input class="form-control mb-2" id="department">

                <label>Estado</label>
                <input class="form-control mb-2" id="state">

                <label>Salario</label>
                <input type="number" class="form-control mb-2" id="salary">

                <label>Fecha de Ingreso</label>
                <input type="date" class="form-control mb-2" id="entryDate">

                <label>Profesional</label>
                <input class="form-control mb-2" id="professionalProfile">

                <label>Nivel Educativo</label>
                <input class="form-control mb-2" id="educationalLevel">

            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button class="btn btn-success" onclick="saveEmployee()">Guardar</button>
            </div>

        </div>
    </div>
</div>


<!-- MODAL IMPORTAR EXCEL -->
<div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Importar Empleados desde Excel</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="file" id="excelFile" accept=".xlsx,.xls" class="form-control">
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-success" onclick="importExcel()">Importar</button>
            </div>
        </div>
    </div>
</div>


<script>
    const apiUrl = "http://localhost:5164/api/Employees";
    let currentEmployee = null; // AquÃ­ guardaremos el empleado completo

    async function openEditModal(documentId) {
        // Traer empleado completo del backend
        const res = await fetch(`${apiUrl}/${documentId}`);
        currentEmployee = await res.json();

        // Llenar modal con todos los campos del empleado
        document.getElementById("document").value = currentEmployee.document;
        document.getElementById("email").value = currentEmployee.email;
        document.getElementById("phone").value = currentEmployee.phone;
        document.getElementById("department").value = currentEmployee.department;
        document.getElementById("state").value = currentEmployee.state;
        document.getElementById("salary").value = currentEmployee.salary;
        document.getElementById("entryDate").value = currentEmployee.entryDate.substring(0, 10); // formato YYYY-MM-DD
        document.getElementById("professionalProfile").value = currentEmployee.professionalProfile;
        document.getElementById("educationalLevel").value = currentEmployee.educationalLevel;

        new bootstrap.Modal(document.getElementById("employeeModal")).show();
    }

    async function saveEmployee() {
        // Actualizamos todos los campos del empleado
        currentEmployee.email = document.getElementById("email").value;
        currentEmployee.phone = document.getElementById("phone").value;
        currentEmployee.department = document.getElementById("department").value;
        currentEmployee.state = document.getElementById("state").value;
        currentEmployee.salary = parseFloat(document.getElementById("salary").value);
        currentEmployee.entryDate = document.getElementById("entryDate").value;
        currentEmployee.professionalProfile = document.getElementById("professionalProfile").value;
        currentEmployee.educationalLevel = document.getElementById("educationalLevel").value;

        // Enviamos TODO el objeto al backend como exige el PUT
        const res = await fetch(`${apiUrl}/${currentEmployee.document}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(currentEmployee)
        });

        if (!res.ok) {
            alert("Error al actualizar. Revisa la consola.");
            console.error(await res.text());
            return;
        }

        location.reload();
    }

    async function deleteEmployee(documentId) {
        if (!confirm("Â¿Seguro que deseas eliminar este empleado?")) return;

        await fetch(`${apiUrl}/${documentId}`, {
            method: "DELETE"
        });

        location.reload();
    }

    function openImportModal() {
        new bootstrap.Modal(document.getElementById("importModal")).show();
    }

    async function importExcel() {
        const file = document.getElementById("excelFile").files[0];

        if (!file) {
            alert("Selecciona un archivo primero.");
            return;
        }

        const formData = new FormData();
        formData.append("file", file);

        const res = await fetch("http://localhost:5164/api/admin/import", {
            method: "POST",
            body: formData
        });

        if (!res.ok) {
            alert("Error importando el Excel");
            console.error(await res.text());
            return;
        }

        alert("ImportaciÃ³n completada exitosamente");
        location.reload();
    }

</script>

